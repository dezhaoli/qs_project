package com.qs.webside.member.service.impl;

import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import com.qs.webside.member.mapper.MemberfidesMapper;
import com.qs.webside.member.model.Memberfides;
import com.qs.webside.member.model.Memberpayment;
import com.qs.webside.member.model.Members;
import com.qs.webside.member.service.MemberService;

import net.rubyeye.xmemcached.MemcachedClient;
import net.rubyeye.xmemcached.exception.MemcachedException;
import weixin.popular.api.SnsAPI;
import weixin.popular.bean.sns.SnsToken;
import weixin.popular.bean.user.User;

import com.qs.webside.member.mapper.MembersMapper;
import com.qs.webside.member.model.Commongame;
import com.qs.common.constant.AppConstants;
import com.qs.common.util.IpUtil;
import com.qs.common.util.crypto.MD5;
import com.qs.webside.member.mapper.CommongameMapper;
import com.qs.webside.member.model.Game;
import com.qs.webside.member.mapper.GameMapper;
import com.qs.webside.member.mapper.MemberpaymentMapper;
import com.qs.webside.member.model.Memberpayment;


@Service("memberService")
public class MemberServiceImpl implements MemberService {
	
    Logger log = Logger.getLogger(MemberServiceImpl.class);  

	@Autowired
	private MemberfidesMapper memberfidesMapper;
	
	@Autowired
	private MembersMapper membersMapper;
	
	@Autowired
	private CommongameMapper commongameMapper;
	
	@Autowired
	private GameMapper gameMapper;
	
	@Autowired
	private MemcachedClient memcachedClient;
	
	@Autowired
	private MemberpaymentMapper memberpaymentMapper;
	
	
	@Autowired
	private RedisTemplate redisTemplate;
	

    @Value("${wepay.appid}")
    private String appId;

    @Value("${wepay.appSecret}")
    private String secret;
    
	
    @Value("${game.gametype}")
    private byte gameType;
	
	/**
	 * 保存token
	 * id 登录 rgb注册,type游戏
	 * @param mid
	 * @param sid
	 * @param rgp
	 * @return
	 */
	@Override
	public String saveToken(Integer mid,Integer gp,Integer rgp,String ip){
		String key=AppConstants.MemcacheKeyPrefix.SESSKEY+mid;
		String ipKey=AppConstants.MemcacheKeyPrefix.IP+mid;
		String istestuser="0";
		long motime=System.currentTimeMillis();
		String sign=MD5.encrypt(mid+"#"+motime+"#"+AppConstants.SAFECODE);
		String mokey=mid+"-"+motime+"-"+gp+"-"+sign+"-"+rgp+"-"+gameType;
		try {
			memcachedClient.add(key,6*3600, mokey);
			memcachedClient.add(ipKey,6*3600, ip);
		} catch (TimeoutException e) {
			e.printStackTrace();
		} catch (InterruptedException e) {
			e.printStackTrace();
		} catch (MemcachedException e) {
			e.printStackTrace();
		}
		return mokey;
	}
   
	@Override
	public Memberfides insertMemberfides(Memberfides record,String openId) {
		Members  member=new Members();
		member.setSitemid(openId);
		int mid=membersMapper.insert(member);
		if(null==record){
			record=new Memberfides();
			record.setName(AppConstants.VISITORNAME);
		}
		record.setMid(mid);
		memberfidesMapper.insertSelective(record);
		
		Commongame commongame=new Commongame();
		commongame.setMid(mid);
		commongame.setGold(0l);
		commongame.setVip((byte)0);
		commongame.setBankpasswd("");
		commongame.setBankassets(0l);
		commongameMapper.insertSelective(commongame);
		
		//从配置文件取数据
		Game game=new Game();
		game.setMid(mid);
		game.setJifen(0l);
		game.setType((int)gameType);
		gameMapper.insertSelective(game);
		
		return record;
	}

	@Override
	public Memberfides findMemberfidesById(Integer id) {
		return memberfidesMapper.selectByPrimaryKey(id);
	}

	@Override
	public int updateMemberfides(Memberfides record) {
		// TODO Auto-generated method stub
		return 0;
	}

	@Override
	public int deleteMemberfidesById(Integer id) {
		// TODO Auto-generated method stub
		return 0;
	}

	@Override
	public Members findMembersBySitemid(String sitemid) {
		return membersMapper.findMembersBySitemid(sitemid);
	}

	@Override
	public int insertMemberpayment(Memberpayment record) {
		return memberpaymentMapper.insert(record);
	}

	@Override
	public Game findGameById(Integer id) {
		return gameMapper.selectByPrimaryKey(id);
	}

	@Override
	public Commongame findCommongameById(Integer id) {
		return commongameMapper.selectByPrimaryKey(id);
	}

	@Override
	public User getInfoByCode(String code) {
		User user=null;
		String tokenCode=AppConstants.RedisKeyPrefix.REFRESH_TOKEN+code;
		String refreshToken=(String)redisTemplate.opsForValue().get(AppConstants.RedisKeyPrefix.REFRESH_TOKEN+code);
		if(null!=refreshToken){
			 SnsToken snsToken=SnsAPI.oauth2RefreshToken(appId, refreshToken);
			 log.debug(snsToken.toString());
			 user=SnsAPI.userinfo(snsToken.getAccess_token(), snsToken.getOpenid(),"zh_CN");
			 log.debug(user.toString());
			redisTemplate.opsForValue().set(tokenCode,snsToken.getRefresh_token(),15*24*3600,TimeUnit.SECONDS);
			
		}else{
			 SnsToken snsToken=SnsAPI.oauth2AccessToken(appId, secret,code);
			 log.debug(snsToken.toString());
			 user=SnsAPI.userinfo(snsToken.getAccess_token(), snsToken.getOpenid(),"zh_CN");
			 log.debug(user.toString());
			redisTemplate.opsForValue().set(tokenCode,snsToken.getRefresh_token(),29*24*3600,TimeUnit.SECONDS);
		}
		
		return user;
	}


}

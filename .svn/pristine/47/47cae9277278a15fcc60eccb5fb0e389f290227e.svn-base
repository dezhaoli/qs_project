package com.qs.webside.agent.service.impl;

import com.alibaba.fastjson.JSONArray;
import com.qs.log.agent.mapper.TaxesInviteWeekMapper;
import com.qs.log.agent.model.TaxesInviteWeek;
import com.qs.log.agent.model.TeamInfo;
import com.qs.webside.agent.service.ITaxesInviteWeekMapperService;
import jodd.util.StringUtil;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.text.SimpleDateFormat;
import java.util.*;

@Service
public class TaxesInviteWeekMapperServiceImpl implements ITaxesInviteWeekMapperService {
 
	@Resource
    private TaxesInviteWeekMapper taxesInviteWeekMapper;

	@Value("${game.gameCode}")
	private String dbName;
	
	@Override
	public int insert(TaxesInviteWeek record) {
		// TODO Auto-generated method stub
		return 0;
	}

	@Override
	public int insertSelective(TaxesInviteWeek record) {
		// TODO Auto-generated method stub
		return 0;
	}

	@Override
	public Map<String, Object> selectByIdTexesInviteWeek(Map<String, Object> param) {
		TaxesInviteWeek  result=new TaxesInviteWeek(); 
		Map<String,Object> map=new HashMap<String,Object>();
		String info="";
		int rebateTotal=0;
		SimpleDateFormat sdf=new SimpleDateFormat("yyyy-MM-dd");
		if (!param.containsKey("date")){
			param.put("date", sdf.format(new Date()));
		}
		
		TaxesInviteWeek  results=taxesInviteWeekMapper.selectByIdTexesInviteWeek(param);
		if (results != null){
			info=results.getInfo();
			if(result.getPaytotal()==null){
				
				map.put("paytotal", result.getPaytotal());
			}else {
				map.put("paytotal", "0");
			}
		}else{
			//数据不存在
			info="[['0','0','0'],['0','0','0'],['0','0','0']]";
			map.put("paytotal", "0");
		}
		map= setStringToMap( info);
		Object one=map.get("teamInfo01");
		Object tow=map.get("teamInfo11");
		Object thr=map.get("teamInfo21");
		rebateTotal=Integer.valueOf(one.toString())+Integer.valueOf(tow.toString())+Integer.valueOf(thr.toString());
		map.put("rebateTotal", rebateTotal);
		return map;
	}

	@Override
	public List<TaxesInviteWeek> findInfoRebatetotalByAgentMidDate(Map<String, Object> parameters) {
		parameters.put("dbName", dbName + ".memberagents");
		return taxesInviteWeekMapper.findInfoRebatetotalByAgentMidDate(parameters);
	}

	@Override
	public List<Map<String, Object>> findMidPaytotalRebatetotalIsawardInfoAgentRealname(Map<String, Object> parameters) {
		List<TaxesInviteWeek> taxesInviteWeekList = findInfoRebatetotalByAgentMidDate(parameters);
		Double weekPayTotal = 0.0;
		Double weekSettleTotal = 0.0;
		for (TaxesInviteWeek taxesInviteWeek : taxesInviteWeekList) {
			String stringInfo = taxesInviteWeek.getInfo();
			if (!StringUtil.isBlank(stringInfo)) {
				JSONArray jsonArray = JSONArray.parseArray(stringInfo);
				String [] arr1 = (String[]) jsonArray.toArray();
				for (String s : arr1) {
					JSONArray jsonArray2 = JSONArray.parseArray(s);
					String [] arr2 = (String[]) jsonArray2.toArray();
					//TODO 2017年3月27日
				}
			}
		}

		parameters.put("dbName", dbName + ".memberagents");
		List<Map<String, Object>> mapList = taxesInviteWeekMapper.findMidPaytotalRebatetotalIsawardInfoAgentRealname(parameters);

		return null;
	}


	public static Map<String,Object> setStringToMap(String info){
		  Map<String,Object> map=new HashMap<String ,Object>();
		  JSONArray js=JSONArray.parseArray(info);
		  for (int i = 0; i < js.size(); i++) {
			  JSONArray jsa=js.getJSONArray(i);
			  for (int j = 0; j < jsa.size(); j++) {
				  map.put("teamInfo"+j+i, jsa.getString(i));
			}
		}
		  return map;
	}
	/**
	 * 将一根字符数组转为map对象
	 * @param info
	 * @return
	 */
	public static Map<String,Object> setStringToMapList(String info){
		  Map<String,Object> map=new HashMap<String ,Object>();
		  JSONArray js=JSONArray.parseArray(info);
		  List<TeamInfo> team=new ArrayList<>();
		  for (int i = 0; i < js.size(); i++) {
			  JSONArray jsa=js.getJSONArray(i);
			  TeamInfo ti=new TeamInfo();
			  for (int j = 0; j < jsa.size(); j++) {
				  if (j==0){
					  ti.setTopUp(jsa.getString(j));
				  }
				  if (j==1){
					  ti.setCount(jsa.getString(j));
				  }
			}
			  team.add(ti);
		}
		  map.put("teamInfo", team);
		  return map;
	}
	
}

package com.qs.webside.api.controller;

import java.util.HashMap;
import java.util.Map;
import javax.annotation.Resource;

import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.qs.cfg.acti.model.Store;
import com.qs.cfg.acti.service.StoreService;
import com.qs.common.base.basecontroller.BaseController;
import com.qs.common.constant.AppConstants;
import com.qs.common.util.DateUtil;
import com.qs.webside.api.service.IAlipayService;
import com.qs.webside.member.model.Commongame;
import com.qs.webside.member.model.Memberfides;
import com.qs.webside.member.model.Memberpayment;
import com.qs.webside.member.service.MemberService;
import com.qs.webside.util.AccessToken;
import com.qs.webside.util.ContextUtil;
import me.hao0.alipay.model.pay.AppPayDetail;
import weixin.popular.api.SnsAPI;
import weixin.popular.bean.sns.SnsToken;
import weixin.popular.bean.user.User;

@Controller
@Scope("prototype")
@RequestMapping("/api/")
public class ApiController extends BaseController {

	
    @Value("${wepay.appid}")
    private String appId;

    @Value("${wepay.appSecret}")
    private String secret;
    
    @Value("${game.hostport}")
    private String hostPort;
    
    @Value("${game.ver}")
    private String ver;
    
    @Value("${game.appurl}")
    private String appUrl;
    
    @Value("${game.gametype}")
    private byte gameType;
   
    @Value("${game.headimgurl}")
    private String headImgUrl;
    
    @Value("${wepay.payNotifyUrl}")
    private String payNotifyUrl;
    
   
	@Autowired
	private MemberService memberService;
	
    @Resource
    private IAlipayService alipayService;
    
	
	@Autowired
	private StoreService storeService;
	
	/**
	 * 登录
	 * @param code
	 * @param type
	 * @param gp
	 * @param channel
	 * @param site
	 * @param deviceid
	 * @return
	 */
	@RequestMapping("login.do")
	@ResponseBody
	public Object login(String code,String type,Integer gp,String channel,String site,String deviceid)
	{
		Map<String, Object> map = new HashMap<String, Object>();
        //根据code取accessToken
		SnsToken snsToken=SnsAPI.oauth2AccessToken(appId, secret, code);
		User user=SnsAPI.userinfo(snsToken.getAccess_token(), snsToken.getOpenid(),"zh_CN");
		Memberfides memberFides = getMemberfides(user);		
		memberFides.setGp((byte)gp.intValue());
		String openId=user.getOpenid();
		Memberfides mb=memberService.findMembersBySitemid(openId);
		if(null!=mb){
		   memberService.insertMemberfides(memberFides,openId);
		}
		
        String sesskey=memberService.saveToken(memberFides.getMid(),gp,(int)memberFides.getGp());
        
		map.put("sesskey",sesskey);
		map.put("server",hostPort);
		map.put("sitemid",openId);
		map.put("ver",ver);
		//房间、商城配置文件路径
		map.put("dataUrl",appUrl+"config/");
		//头像路径
		map.put("mobileUrl",headImgUrl);
		//移动活动
		map.put("baseUrl",appUrl+"api/mobile/");

		return this.getReturnData(map,AppConstants.Result.SUCCESS);
	}
	
	/***
	 * 订单
	 * @param sesskey
	 * @param type
	 * @param money
	 * @return
	 */
	@RequestMapping("getOrder.do")
	@ResponseBody
	public Object getOrder(String sesskey,String type,Integer money,Integer storeId){
		Map<String, Object> map = new HashMap<String, Object>();
		String queryString="";
		String cardid="1";
		AccessToken token=ContextUtil.getAccessTokenInfo(sesskey);
		
		Memberfides user=memberService.findMemberfidesById(token.getMid());
		Commongame commongame=memberService.findCommongameById(token.getMid());
		Integer gold=0;
		if(StringUtils.isBlank(String.valueOf(storeId))){
			storeId=money;
		}
		
		gold=storeService.findGoldByStoreId(storeId);
		
		Memberpayment record=new Memberpayment();
		record.setFmid(token.getMid());
		record.setTmid(token.getMid());
		record.setTsid(user.getGp().intValue());
		record.setPmoneynow(commongame.getGold().intValue());
		record.setPcard(token.getGb().shortValue());
		record.setPamount((float)money);
		record.setPcoins(0);
		record.setPtime(DateUtil.currentTimeToInt());
		record.setPstatus((byte)0);
		record.setPtransno("");
		record.setGametype(gameType);
	
		if(AppConstants.PayType.ALIPAY.equals(type)){
			record.setPmode((byte)2);
			Integer orderId=memberService.insertMemberpayment(record);
	        String orderNameAndBody = gold+ AppConstants.COINNAME;
	        AppPayDetail appPayDetail = new AppPayDetail(String.valueOf(orderId), orderNameAndBody,String.valueOf(money), orderNameAndBody);
	        queryString=alipayService.appPay(appPayDetail);
	        
		}else if(AppConstants.PayType.WXPAY.equals(type)){
			record.setPmode((byte)7);
			Integer orderId=memberService.insertMemberpayment(record);	
			queryString=payNotifyUrl;
			cardid=String.valueOf(orderId);
		}
		
		map.put("string",queryString);
		map.put("cardid",cardid);
		return this.getReturnData(map,AppConstants.Result.SUCCESS);
	
		
	}
	
	
	/**
	 * APP更新
	 * @param sesskey
	 * @param type
	 * @param money
	 * @return
	 */
	@RequestMapping("getAutoUpdateInfo.do")
	@ResponseBody
	public Object getAutoUpdateInfo(String sesskey,String type,Integer money){
		Map<String, Object> map = new HashMap<String, Object>();
		
		return map;
  }	


	private Memberfides getMemberfides(User user) {
		Memberfides member=new Memberfides();
		member.setName(user.getNickname());
		if(null!=user.getSex()){
			 member.setSex(user.getSex().byteValue());
		}
		member.setCity(user.getCity());
		member.setIcon(user.getHeadimgurl());
	    //member.setInvite(invite);
	    //member.setGp(();
		member.setMtime(System.currentTimeMillis());
		member.setLxlg(DateUtil.currentTimeToInt());
		return member;
	}
	
	



	
}
